<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>IKEv1中的证书认证详述(SM2国密证书) | zrf's blog</title><meta name="author" content="zrf,853241825@qq.com"><meta name="copyright" content="zrf"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一. 简介 1.1 主要内容 1.2 全文结构 1.3 网络拓扑 1.4 参考链接   二. 创建证书 2.1 创建自签名CA根证书 2.2 为sun站点颁发证书 2.3 为moon站点颁发证书   三. 使用国密算法协商IKE SA 3.1 网络拓扑 3.2 sun站点配置 3.3 moon站点配置 3.3 两个站点加载配置并读取证书 3.4 协商IKE SA 3.5 总结   四.">
<meta property="og:type" content="article">
<meta property="og:title" content="IKEv1中的证书认证详述(SM2国密证书)">
<meta property="og:url" content="https://zzzzrf.github.io/2024/03/30/IKEv1_pubkey_auth/index.html">
<meta property="og:site_name" content="zrf&#39;s blog">
<meta property="og:description" content="一. 简介 1.1 主要内容 1.2 全文结构 1.3 网络拓扑 1.4 参考链接   二. 创建证书 2.1 创建自签名CA根证书 2.2 为sun站点颁发证书 2.3 为moon站点颁发证书   三. 使用国密算法协商IKE SA 3.1 网络拓扑 3.2 sun站点配置 3.3 moon站点配置 3.3 两个站点加载配置并读取证书 3.4 协商IKE SA 3.5 总结   四.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zzzzrf.github.io/blog_image/20231203-01/cover.png">
<meta property="article:published_time" content="2024-03-30T15:10:26.000Z">
<meta property="article:modified_time" content="2025-02-13T11:53:20.680Z">
<meta property="article:author" content="zrf">
<meta property="article:tag" content="strongswan">
<meta property="article:tag" content="非对称加密算法">
<meta property="article:tag" content="CA机构与证书">
<meta property="article:tag" content="国密算法">
<meta property="article:tag" content="证书认证">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zzzzrf.github.io/blog_image/20231203-01/cover.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "IKEv1中的证书认证详述(SM2国密证书)",
  "url": "https://zzzzrf.github.io/2024/03/30/IKEv1_pubkey_auth/",
  "image": "https://zzzzrf.github.io/blog_image/20231203-01/cover.png",
  "datePublished": "2024-03-30T15:10:26.000Z",
  "dateModified": "2025-02-13T11:53:20.680Z",
  "author": [
    {
      "@type": "Person",
      "name": "zrf",
      "url": "https://zzzzrf.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zzzzrf.github.io/2024/03/30/IKEv1_pubkey_auth/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')
          
          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: zrf","link":"链接: ","source":"来源: zrf's blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'IKEv1中的证书认证详述(SM2国密证书)',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/back.jpeg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/blog_image/20231203-01/cover.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">zrf's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">IKEv1中的证书认证详述(SM2国密证书)</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">IKEv1中的证书认证详述(SM2国密证书)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-30T15:10:26.000Z" title="发表于 2024-03-30 23:10:26">2024-03-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-02-13T11:53:20.680Z" title="更新于 2025-02-13 19:53:20">2025-02-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/IPSEC/">IPSEC</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">6.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>32分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2025-02-13 19:53:20&quot;}" hidden></div><!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

<ul>
<li><a href="#%E4%B8%80-%E7%AE%80%E4%BB%8B">一. 简介</a><ul>
<li><a href="#11-%E4%B8%BB%E8%A6%81%E5%86%85%E5%AE%B9">1.1 主要内容</a></li>
<li><a href="#12-%E5%85%A8%E6%96%87%E7%BB%93%E6%9E%84">1.2 全文结构</a></li>
<li><a href="#13-%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91">1.3 网络拓扑</a></li>
<li><a href="#14-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">1.4 参考链接</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C-%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6">二. 创建证书</a><ul>
<li><a href="#21-%E5%88%9B%E5%BB%BA%E8%87%AA%E7%AD%BE%E5%90%8Dca%E6%A0%B9%E8%AF%81%E4%B9%A6">2.1 创建自签名CA根证书</a></li>
<li><a href="#22-%E4%B8%BAsun%E7%AB%99%E7%82%B9%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6">2.2 为sun站点颁发证书</a></li>
<li><a href="#23-%E4%B8%BAmoon%E7%AB%99%E7%82%B9%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6">2.3 为moon站点颁发证书</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89-%E4%BD%BF%E7%94%A8%E5%9B%BD%E5%AF%86%E7%AE%97%E6%B3%95%E5%8D%8F%E5%95%86ike-sa">三. 使用国密算法协商<code>IKE SA</code></a><ul>
<li><a href="#31-%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91">3.1 网络拓扑</a></li>
<li><a href="#32-sun%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE">3.2 sun站点配置</a></li>
<li><a href="#33-moon%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE">3.3 moon站点配置</a></li>
<li><a href="#33-%E4%B8%A4%E4%B8%AA%E7%AB%99%E7%82%B9%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E5%B9%B6%E8%AF%BB%E5%8F%96%E8%AF%81%E4%B9%A6">3.3 两个站点加载配置并读取证书</a></li>
<li><a href="#34-%E5%8D%8F%E5%95%86ike-sa">3.4 协商IKE SA</a></li>
<li><a href="#35-%E6%80%BB%E7%BB%93">3.5 总结</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9B-%E6%8A%A5%E6%96%87%E5%88%86%E6%9E%90">四. 报文分析</a><ul>
<li><a href="#41-%E5%88%9B%E5%BB%BA%E5%AE%89%E5%85%A8%E6%8F%90%E6%A1%88">4.1 创建安全提案</a></li>
<li><a href="#42-%E4%BA%A4%E6%8D%A2dh%E5%85%AC%E9%92%A5">4.2 交换DH公钥</a><ul>
<li><a href="#1-dh%E7%AE%97%E6%B3%95">1. DH算法</a></li>
<li><a href="#2-key-exchange-payload">2. KEY EXCHANGE PAYLOAD</a></li>
<li><a href="#3-%E6%80%BB%E7%BB%93">3. 总结</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E4%BA%94-%E4%BF%9D%E6%8A%A4ike_auth%E7%9A%84%E5%AF%86%E9%92%A5%E6%98%AF%E5%A6%82%E4%BD%95%E4%BA%A7%E7%94%9F%E7%9A%84">五. 保护IKE_AUTH的密钥是如何产生的</a><ul>
<li><a href="#51-skeyid">5.1 SKEYID</a></li>
<li><a href="#52-skeyid_d">5.2 SKEYID_d</a></li>
<li><a href="#53-skeyid_a">5.3 SKEYID_a</a></li>
<li><a href="#54-skeyid_e">5.4 SKEYID_e</a></li>
<li><a href="#55-ka">5.5 KA</a></li>
</ul>
</li>
<li><a href="#%E5%85%AD-%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81">六. 证书认证</a><ul>
<li><a href="#61-%E8%AF%81%E4%B9%A6%E8%AF%B7%E6%B1%82">6.1 证书请求</a></li>
<li><a href="#62-ike_auth">6.2 IKE_AUTH</a><ul>
<li><a href="#1-identification">1. Identification</a></li>
<li><a href="#2-certificate">2. Certificate</a></li>
<li><a href="#3-signature">3. Signature</a></li>
</ul>
</li>
<li><a href="#63-%E7%AD%BE%E5%90%8D%E4%B8%8E%E9%AA%8C%E7%AD%BE">6.3 签名与验签</a><ul>
<li><a href="#1-%E7%AD%BE%E5%90%8D">1. 签名</a></li>
<li><a href="#2-%E9%AA%8C%E7%AD%BE">2. 验签</a></li>
</ul>
</li>
<li><a href="#64-%E5%A6%82%E4%BD%95%E8%8E%B7%E5%BE%97%E5%AF%B9%E7%AB%AF%E7%9A%84%E5%85%AC%E9%92%A5">6.4 如何获得对端的公钥</a></li>
</ul>
</li>
</ul>
<!-- /code_chunk_output -->


<h2 id="一-简介"><a href="#一-简介" class="headerlink" title="一. 简介"></a>一. 简介</h2><h3 id="1-1-主要内容"><a href="#1-1-主要内容" class="headerlink" title="1.1 主要内容"></a>1.1 主要内容</h3><p>本文将基于strongswan，详细阐述IKE(Internet Key Exchange，网络密钥交换)协议中的以下关键问题:</p>
<ul>
<li>为了避免密钥泄漏，两个站点如何<strong>使用DH算法，衍生出一个共同的密钥</strong><code>shared Diffie Hellman secret</code>。</li>
<li>如何使用一系列衍生密钥，在<strong>IKE_AUTH阶段保护双方的身份信息</strong>。</li>
<li>如何通过<strong>证书认证</strong>，确保对端的合法身份。</li>
</ul>
<p>本文将使用<strong>SM2国密证书</strong>，通过IKEv1协议，建立IKE SA。</p>
<h3 id="1-2-全文结构"><a href="#1-2-全文结构" class="headerlink" title="1.2 全文结构"></a>1.2 全文结构</h3><ul>
<li>创建根CA证书，并为两个站点颁发国密证书。</li>
<li>使用<code>SM3</code>摘要算法、<code>SM4</code>加密算法、<code>SM2 DH</code>算法协商<code>IKE SA</code>。</li>
<li>展示<code>SM2 DH</code>算法在两个站点生成共享密钥<code>g_xy</code>，并使用衍生密钥<code>Ka</code>对<code>IKE_AUTH</code>阶段加密。</li>
<li>分析ISAKMP的<code>IKE_AUTH</code>阶段的报文</li>
<li>双方如何通过证书来验证对端的合法身份。</li>
</ul>
<h3 id="1-3-网络拓扑"><a href="#1-3-网络拓扑" class="headerlink" title="1.3 网络拓扑"></a>1.3 网络拓扑</h3><p>本为旨在分析IKE SA的建立过程，所以使用最基础的host-host场景</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| 10.1.0.1 |    ===    | 10.1.0.2 |</span><br><span class="line">    sun                    moon</span><br></pre></td></tr></table></figure>

<h3 id="1-4-参考链接"><a href="#1-4-参考链接" class="headerlink" title="1.4 参考链接"></a>1.4 参考链接</h3><p><a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc2409">IKEv1 RFC 22409</a><br><a target="_blank" rel="noopener" href="https://www.strongswan.org/documentation.html">strongswan官网文档</a><br><a target="_blank" rel="noopener" href="https://zrfyun.top/2023/12/03/20231203-01/">非对称加密算法与CA机构</a></p>
<h2 id="二-创建证书"><a href="#二-创建证书" class="headerlink" title="二. 创建证书"></a>二. 创建证书</h2><p>本节所有证书的密钥对都将使用<strong>SM2算法</strong>生成、并使用<strong>SM2-with-SM3</strong>作为证书的签名算法。</p>
<h3 id="2-1-创建自签名CA根证书"><a href="#2-1-创建自签名CA根证书" class="headerlink" title="2.1 创建自签名CA根证书"></a>2.1 创建自签名CA根证书</h3><ul>
<li>使用SM2算法生成CA的私钥</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/tmp/sm2_cert$ pki --gen --type sm2 --outform pem &gt; caKey.pem</span><br><span class="line">zrf@debian:/tmp/sm2_cert$ </span><br><span class="line">zrf@debian:/tmp/sm2_cert$ cat caKey.pem </span><br><span class="line">-----BEGIN EC PRIVATE KEY-----</span><br><span class="line">MHcCAQEEIFEWgyAmZ1TN8C6X1rlFwYdbetwuP/ieFgBbk9g+8ZTWoAoGCCqBHM9V</span><br><span class="line">AYItoUQDQgAEox4kzxpegfjQ+R+Kp8VXytbAFAF4QSKKrdeOVdo0MFWi3FJtChsL</span><br><span class="line">7ZbHsJk4US7D+NDFeadzsZ7kDVVWKWh0aA==</span><br><span class="line">-----END EC PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<ul>
<li>创建自签名CA证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/tmp/sm2_cert$ pki --self --ca --lifetime 3652 --in caKey.pem --dn &quot;C=CN, O=zrf, CN=zrf CA&quot; --outform pem &gt; caCert.pem</span><br><span class="line">zrf@debian:/tmp/sm2_cert$ </span><br><span class="line">zrf@debian:/tmp/sm2_cert$ openssl x509 --in caCert.pem -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 6144011213922486727 (0x5543e9a58dddc9c7)</span><br><span class="line">        Signature Algorithm: SM2-with-SM3</span><br><span class="line">        Issuer: C=CN, O=zrf, CN=zrf CA</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Mar 30 08:01:08 2024 GMT</span><br><span class="line">            Not After : Mar 30 08:01:08 2034 GMT</span><br><span class="line">        Subject: C=CN, O=zrf, CN=zrf CA</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: id-ecPublicKey</span><br><span class="line">                Public-Key: (256 bit)</span><br><span class="line">                pub:</span><br><span class="line">                    04:a3:1e:24:cf:1a:5e:81:f8:d0:f9:1f:8a:a7:c5:</span><br><span class="line">                    57:ca:d6:c0:14:01:78:41:22:8a:ad:d7:8e:55:da:</span><br><span class="line">                    34:30:55:a2:dc:52:6d:0a:1b:0b:ed:96:c7:b0:99:</span><br><span class="line">                    38:51:2e:c3:f8:d0:c5:79:a7:73:b1:9e:e4:0d:55:</span><br><span class="line">                    56:29:68:74:68</span><br><span class="line">                ASN1 OID: SM2</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:TRUE</span><br><span class="line">            X509v3 Key Usage: critical</span><br><span class="line">                Certificate Sign, CRL Sign</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                8A:12:AF:31:8E:83:B5:4B:2C:BB:B1:5D:DE:FC:4F:3B:63:A8:2A:F9</span><br><span class="line">    Signature Algorithm: SM2-with-SM3</span><br><span class="line">    Signature Value:</span><br><span class="line">        2d:43:ea:e0:51:10:b5:5e:54:0e:38:9f:37:5d:4d:8b:91:4e:</span><br><span class="line">        23:05:4f:c9:58:0d:b1:f9:d9:39:1a:bd:b5:31:0f:2a:ee:75:</span><br><span class="line">        b3:41:d8:8f:d3:a9:41:f9:2e:87:17:2f:c9:4d:81:3d:e6:d3:</span><br><span class="line">        49:25:b4:14:42:cd:a7:56:42:79</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIBjTCCATigAwIBAgIIVUPppY3dyccwDAYIKoEcz1UBg3UFADAsMQswCQYDVQQG</span><br><span class="line">EwJDTjEMMAoGA1UEChMDenJmMQ8wDQYDVQQDEwZ6cmYgQ0EwHhcNMjQwMzMwMDgw</span><br><span class="line">MTA4WhcNMzQwMzMwMDgwMTA4WjAsMQswCQYDVQQGEwJDTjEMMAoGA1UEChMDenJm</span><br><span class="line">MQ8wDQYDVQQDEwZ6cmYgQ0EwWTATBgcqhkjOPQIBBggqgRzPVQGCLQNCAASjHiTP</span><br><span class="line">Gl6B+ND5H4qnxVfK1sAUAXhBIoqt145V2jQwVaLcUm0KGwvtlsewmThRLsP40MV5</span><br><span class="line">p3OxnuQNVVYpaHRoo0IwQDAPBgNVHRMBAf8EBTADAQH/MA4GA1UdDwEB/wQEAwIB</span><br><span class="line">BjAdBgNVHQ4EFgQUihKvMY6DtUssu7Fd3vxPO2OoKvkwDAYIKoEcz1UBg3UFAANB</span><br><span class="line">AC1D6uBRELVeVA44nzddTYuRTiMFT8lYDbH52TkavbUxDyrudbNB2I/TqUH5LocX</span><br><span class="line">L8lNgT3m00kltBRCzadWQnk=</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">zrf@debian:/tmp/sm2_cert$ </span><br></pre></td></tr></table></figure>

<h3 id="2-2-为sun站点颁发证书"><a href="#2-2-为sun站点颁发证书" class="headerlink" title="2.2 为sun站点颁发证书"></a>2.2 为sun站点颁发证书</h3><ul>
<li>创建sun站点私钥</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/tmp/sm2_cert$ pki --gen --type sm2 --outform pem &gt; sunKey.pem</span><br><span class="line">zrf@debian:/tmp/sm2_cert$ cat sunKey.pem </span><br><span class="line">-----BEGIN EC PRIVATE KEY-----</span><br><span class="line">MHcCAQEEIMLdr3KCdINvkTkxzuvCE+8QU5d4T6LlsxEbuBecTT7MoAoGCCqBHM9V</span><br><span class="line">AYItoUQDQgAEFs+zA+xs+8UJPZfjuCwMLJ9BOrri2YlHJQXziNSJd+5K1/eAo+dM</span><br><span class="line">62ioSnUXBOSOTiSwfZ1Ptp0nhr5G2lR6YQ==</span><br><span class="line">-----END EC PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<ul>
<li>提交证书申请</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/tmp/sm2_cert$ pki --req --type sm2 --in sunKey.pem --dn &quot;C=CN, O=zrf, CN=zrf sun&quot; --san 10.1.0.1 --outform pem &gt; sunReq.pem</span><br><span class="line">zrf@debian:/tmp/sm2_cert$ </span><br><span class="line">zrf@debian:/tmp/sm2_cert$ openssl req -in sunReq.pem -text</span><br><span class="line">Certificate Request:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 1 (0x0)</span><br><span class="line">        Subject: C=CN, O=zrf, CN=zrf sun</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: id-ecPublicKey</span><br><span class="line">                Public-Key: (256 bit)</span><br><span class="line">                pub:</span><br><span class="line">                    04:16:cf:b3:03:ec:6c:fb:c5:09:3d:97:e3:b8:2c:</span><br><span class="line">                    0c:2c:9f:41:3a:ba:e2:d9:89:47:25:05:f3:88:d4:</span><br><span class="line">                    89:77:ee:4a:d7:f7:80:a3:e7:4c:eb:68:a8:4a:75:</span><br><span class="line">                    17:04:e4:8e:4e:24:b0:7d:9d:4f:b6:9d:27:86:be:</span><br><span class="line">                    46:da:54:7a:61</span><br><span class="line">                ASN1 OID: SM2</span><br><span class="line">        Attributes:</span><br><span class="line">            Requested Extensions:</span><br><span class="line">                X509v3 Subject Alternative Name: </span><br><span class="line">                    IP Address:10.1.0.1</span><br><span class="line">    Signature Algorithm: SM2-with-SM3</span><br><span class="line">    Signature Value:</span><br><span class="line">        64:0e:fe:fc:7d:3f:71:f9:60:a1:38:2f:af:94:18:66:15:ae:</span><br><span class="line">        b4:f3:ae:45:b7:72:01:2b:f8:69:6b:4e:33:d3:9f:f0:e4:59:</span><br><span class="line">        ea:32:c9:28:01:8c:fa:f3:68:ad:b5:83:a0:cc:e8:17:b8:40:</span><br><span class="line">        17:b3:ea:eb:d9:cf:16:db:03:49</span><br><span class="line">-----BEGIN CERTIFICATE REQUEST-----</span><br><span class="line">MIIBBTCBsQIBADAtMQswCQYDVQQGEwJDTjEMMAoGA1UEChMDenJmMRAwDgYDVQQD</span><br><span class="line">Ewd6cmYgc3VuMFkwEwYHKoZIzj0CAQYIKoEcz1UBgi0DQgAEFs+zA+xs+8UJPZfj</span><br><span class="line">uCwMLJ9BOrri2YlHJQXziNSJd+5K1/eAo+dM62ioSnUXBOSOTiSwfZ1Ptp0nhr5G</span><br><span class="line">2lR6YaAiMCAGCSqGSIb3DQEJDjETMBEwDwYDVR0RBAgwBocECgEAATAMBggqgRzP</span><br><span class="line">VQGDdQUAA0EAZA7+/H0/cflgoTgvr5QYZhWutPOuRbdyASv4aWtOM9Of8ORZ6jLJ</span><br><span class="line">KAGM+vNorbWDoMzoF7hAF7Pq69nPFtsDSQ==</span><br><span class="line">-----END CERTIFICATE REQUEST-----</span><br></pre></td></tr></table></figure>

<ul>
<li>CA为sun颁发五年有效期的SM2国密证书</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/tmp/sm2_cert$ openssl x509 -<span class="keyword">in</span> sunCert.pem -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Signature Algorithm: SM2-with-SM3</span><br><span class="line">        Issuer: C=CN, O=zrf, CN=zrf CA</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Mar 30 08:13:17 2024 GMT</span><br><span class="line">            Not After : Mar 30 08:13:17 2029 GMT</span><br><span class="line">        Subject: C=CN, O=zrf, CN=zrf sun</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: id-ecPublicKey</span><br><span class="line">                Public-Key: (256 bit)</span><br><span class="line">                pub:</span><br><span class="line">                    04:16:cf:b3:03:ec:6c:fb:c5:09:3d:97:e3:b8:2c:</span><br><span class="line">                    0c:2c:9f:41:3a:ba:e2:d9:89:47:25:05:f3:88:d4:</span><br><span class="line">                    89:77:ee:4a:d7:f7:80:a3:e7:4c:eb:68:a8:4a:75:</span><br><span class="line">                    17:04:e4:8e:4e:24:b0:7d:9d:4f:b6:9d:27:86:be:</span><br><span class="line">                    46:da:54:7a:61</span><br><span class="line">                ASN1 OID: SM2</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                8A:12:AF:31:8E:83:B5:4B:2C:BB:B1:5D:DE:FC:4F:3B:63:A8:2A:F9</span><br><span class="line">            X509v3 Subject Alternative Name: </span><br><span class="line">                IP Address:10.1.0.1</span><br><span class="line">    Signature Algorithm: SM2-with-SM3</span><br><span class="line">    Signature Value:</span><br><span class="line">        4f:88:b7:e0:00:f0:b9:8f:8c:72:74:fb:fd:97:20:72:98:2b:</span><br><span class="line">        bd:a5:31:fa:eb:6b:ee:15:91:7b:9d:5b:8a:5e:3b:a8:0f:1c:</span><br><span class="line">        44:c9:f3:13:f6:13:c7:82:19:af:b7:ca:80:d6:1c:f0:07:d7:</span><br><span class="line">        bd:17:9f:bd:45:70:25:c0:e2:d3</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIBeTCCASSgAwIBAgIBATAMBggqgRzPVQGDdQUAMCwxCzAJBgNVBAYTAkNOMQww</span><br><span class="line">CgYDVQQKEwN6cmYxDzANBgNVBAMTBnpyZiBDQTAeFw0yNDAzMzAwODEzMTdaFw0y</span><br><span class="line">OTAzMzAwODEzMTdaMC0xCzAJBgNVBAYTAkNOMQwwCgYDVQQKEwN6cmYxEDAOBgNV</span><br><span class="line">BAMTB3pyZiBzdW4wWTATBgcqhkjOPQIBBggqgRzPVQGCLQNCAAQWz7MD7Gz7xQk9</span><br><span class="line">l+O4LAwsn0E6uuLZiUclBfOI1Il37krX94Cj50zraKhKdRcE5I5OJLB9nU+2nSeG</span><br><span class="line">vkbaVHphozQwMjAfBgNVHSMEGDAWgBSKEq8xjoO1Syy7sV3e/E87Y6gq+TAPBgNV</span><br><span class="line">HREECDAGhwQKAQABMAwGCCqBHM9VAYN1BQADQQBPiLfgAPC5j4xydPv9lyBymCu9</span><br><span class="line">pTH662vuFZF7nVuKXjuoDxxEyfMT9hPHghmvt8qA1hzwB9e9F5+9RXAlwOLT</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure>

<ul>
<li>验证sun证书的合法性</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/tmp/sm2_cert$ pki -v -c caCert.pem -i sunCert.pem </span><br><span class="line">  using certificate <span class="string">&quot;C=CN, O=zrf, CN=zrf sun&quot;</span></span><br><span class="line">  using trusted ca certificate <span class="string">&quot;C=CN, O=zrf, CN=zrf CA&quot;</span></span><br><span class="line">  reached self-signed root ca with a path length of 0</span><br><span class="line">certificate trusted, lifetimes valid</span><br></pre></td></tr></table></figure>

<h3 id="2-3-为moon站点颁发证书"><a href="#2-3-为moon站点颁发证书" class="headerlink" title="2.3 为moon站点颁发证书"></a>2.3 为moon站点颁发证书</h3><ul>
<li>创建moon站点私钥</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/tmp/sm2_cert$ pki --gen --type sm2 --outform pem &gt; moonKey.pem</span><br><span class="line">zrf@debian:/tmp/sm2_cert$ </span><br><span class="line">zrf@debian:/tmp/sm2_cert$ cat moonKey.pem </span><br><span class="line">-----BEGIN EC PRIVATE KEY-----</span><br><span class="line">MHcCAQEEIFUaXdWOslMUud4+Uld8UrxLBtdx8MQAtFYgEtKXb+k0oAoGCCqBHM9V</span><br><span class="line">AYItoUQDQgAEMZenVS79IO6SP1nEapgeHEduGQJ5BqmtaZQFJ5nhxX1dykYaZniq</span><br><span class="line">xNVcK6HYwR3UTYcybbIsH7QpbV2+avbvbA==</span><br><span class="line">-----END EC PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<ul>
<li>提交证书申请</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/tmp/sm2_cert$ pki --req --type sm2 --in moonKey.pem --dn &quot;C=CN, O=zrf, CN=zrf moon&quot; --san 10.1.0.2 --outform pem &gt; moonReq.pem</span><br><span class="line">zrf@debian:/tmp/sm2_cert$ </span><br><span class="line">zrf@debian:/tmp/sm2_cert$ openssl req --in moonReq.pem -text</span><br><span class="line">Certificate Request:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 1 (0x0)</span><br><span class="line">        Subject: C=CN, O=zrf, CN=zrf moon</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: id-ecPublicKey</span><br><span class="line">                Public-Key: (256 bit)</span><br><span class="line">                pub:</span><br><span class="line">                    04:31:97:a7:55:2e:fd:20:ee:92:3f:59:c4:6a:98:</span><br><span class="line">                    1e:1c:47:6e:19:02:79:06:a9:ad:69:94:05:27:99:</span><br><span class="line">                    e1:c5:7d:5d:ca:46:1a:66:78:aa:c4:d5:5c:2b:a1:</span><br><span class="line">                    d8:c1:1d:d4:4d:87:32:6d:b2:2c:1f:b4:29:6d:5d:</span><br><span class="line">                    be:6a:f6:ef:6c</span><br><span class="line">                ASN1 OID: SM2</span><br><span class="line">        Attributes:</span><br><span class="line">            Requested Extensions:</span><br><span class="line">                X509v3 Subject Alternative Name: </span><br><span class="line">                    IP Address:10.1.0.2</span><br><span class="line">    Signature Algorithm: SM2-with-SM3</span><br><span class="line">    Signature Value:</span><br><span class="line">        b0:e5:e7:43:40:0a:53:22:19:7f:c2:fc:9c:bd:e5:a5:12:17:</span><br><span class="line">        4e:6c:d2:cb:85:d4:af:aa:02:f4:e4:fa:a5:fb:e8:d9:b6:cb:</span><br><span class="line">        a5:81:f3:5b:76:4b:46:ba:31:d2:0c:97:ad:25:28:b5:f0:df:</span><br><span class="line">        14:73:d6:40:13:3b:f5:ef:31:7b</span><br><span class="line">-----BEGIN CERTIFICATE REQUEST-----</span><br><span class="line">MIIBBjCBsgIBADAuMQswCQYDVQQGEwJDTjEMMAoGA1UEChMDenJmMREwDwYDVQQD</span><br><span class="line">Ewh6cmYgbW9vbjBZMBMGByqGSM49AgEGCCqBHM9VAYItA0IABDGXp1Uu/SDukj9Z</span><br><span class="line">xGqYHhxHbhkCeQaprWmUBSeZ4cV9XcpGGmZ4qsTVXCuh2MEd1E2HMm2yLB+0KW1d</span><br><span class="line">vmr272ygIjAgBgkqhkiG9w0BCQ4xEzARMA8GA1UdEQQIMAaHBAoBAAIwDAYIKoEc</span><br><span class="line">z1UBg3UFAANBALDl50NAClMiGX/C/Jy95aUSF05s0suF1K+qAvTk+qX76Nm2y6WB</span><br><span class="line">81t2S0a6MdIMl60lKLXw3xRz1kATO/XvMXs=</span><br><span class="line">-----END CERTIFICATE REQUEST-----</span><br></pre></td></tr></table></figure>

<ul>
<li>CA为moon颁发五年有效期的SM2国密证书</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/tmp/sm2_cert$ pki --issue --cacert caCert.pem --cakey caKey.pem --<span class="built_in">type</span> pkcs10 --<span class="keyword">in</span> moonReq.pem --serial 02 --lifetime 1826 --outform pem &gt; moonCert.pem</span><br><span class="line">zrf@debian:/tmp/sm2_cert$ </span><br><span class="line">zrf@debian:/tmp/sm2_cert$ openssl x509 -<span class="keyword">in</span> moonCert.pem -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 2 (0x2)</span><br><span class="line">        Signature Algorithm: SM2-with-SM3</span><br><span class="line">        Issuer: C=CN, O=zrf, CN=zrf CA</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Mar 30 08:19:06 2024 GMT</span><br><span class="line">            Not After : Mar 30 08:19:06 2029 GMT</span><br><span class="line">        Subject: C=CN, O=zrf, CN=zrf moon</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: id-ecPublicKey</span><br><span class="line">                Public-Key: (256 bit)</span><br><span class="line">                pub:</span><br><span class="line">                    04:31:97:a7:55:2e:fd:20:ee:92:3f:59:c4:6a:98:</span><br><span class="line">                    1e:1c:47:6e:19:02:79:06:a9:ad:69:94:05:27:99:</span><br><span class="line">                    e1:c5:7d:5d:ca:46:1a:66:78:aa:c4:d5:5c:2b:a1:</span><br><span class="line">                    d8:c1:1d:d4:4d:87:32:6d:b2:2c:1f:b4:29:6d:5d:</span><br><span class="line">                    be:6a:f6:ef:6c</span><br><span class="line">                ASN1 OID: SM2</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                8A:12:AF:31:8E:83:B5:4B:2C:BB:B1:5D:DE:FC:4F:3B:63:A8:2A:F9</span><br><span class="line">            X509v3 Subject Alternative Name: </span><br><span class="line">                IP Address:10.1.0.2</span><br><span class="line">    Signature Algorithm: SM2-with-SM3</span><br><span class="line">    Signature Value:</span><br><span class="line">        4e:4a:cf:13:13:15:f8:5d:a0:85:90:67:ff:86:7c:d4:5c:14:</span><br><span class="line">        2d:06:<span class="built_in">cd</span>:e7:19:d7:5b:ee:c2:b5:c0:fa:e3:44:a7:c3:eb:3d:</span><br><span class="line">        26:1e:4d:33:d9:43:2f:69:9b:5a:<span class="built_in">fc</span>:f2:37:75:1e:cc:e4:c8:</span><br><span class="line">        98:76:36:ca:92:97:0f:ff:9f:58</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIBejCCASWgAwIBAgIBAjAMBggqgRzPVQGDdQUAMCwxCzAJBgNVBAYTAkNOMQww</span><br><span class="line">CgYDVQQKEwN6cmYxDzANBgNVBAMTBnpyZiBDQTAeFw0yNDAzMzAwODE5MDZaFw0y</span><br><span class="line">OTAzMzAwODE5MDZaMC4xCzAJBgNVBAYTAkNOMQwwCgYDVQQKEwN6cmYxETAPBgNV</span><br><span class="line">BAMTCHpyZiBtb29uMFkwEwYHKoZIzj0CAQYIKoEcz1UBgi0DQgAEMZenVS79IO6S</span><br><span class="line">P1nEapgeHEduGQJ5BqmtaZQFJ5nhxX1dykYaZniqxNVcK6HYwR3UTYcybbIsH7Qp</span><br><span class="line">bV2+avbvbKM0MDIwHwYDVR0jBBgwFoAUihKvMY6DtUssu7Fd3vxPO2OoKvkwDwYD</span><br><span class="line">VR0RBAgwBocECgEAAjAMBggqgRzPVQGDdQUAA0EATkrPExMV+F2ghZBn/4Z81FwU</span><br><span class="line">LQbN5xnXW+7CtcD640Snw+s9Jh5NM9lDL2mbWvzyN3UezOTImHY2ypKXD/+fWA==</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure>

<ul>
<li>验证moon证书的合法性</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/tmp/sm2_cert$ pki -v -c caCert.pem -i moonCert.pem </span><br><span class="line">  using certificate <span class="string">&quot;C=CN, O=zrf, CN=zrf moon&quot;</span></span><br><span class="line">  using trusted ca certificate <span class="string">&quot;C=CN, O=zrf, CN=zrf CA&quot;</span></span><br><span class="line">  reached self-signed root ca with a path length of 0</span><br><span class="line">certificate trusted, lifetimes valid</span><br></pre></td></tr></table></figure>

<h2 id="三-使用国密算法协商IKE-SA"><a href="#三-使用国密算法协商IKE-SA" class="headerlink" title="三. 使用国密算法协商IKE SA"></a>三. 使用国密算法协商<code>IKE SA</code></h2><h3 id="3-1-网络拓扑"><a href="#3-1-网络拓扑" class="headerlink" title="3.1 网络拓扑"></a>3.1 网络拓扑</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">| 10.1.0.1 |    ===    | 10.1.0.2 |</span><br><span class="line">    sun                    moon</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:/etc/netns/sun/swanctl$ sudo cp /tmp/sm2_cert/sunCert.pem x509/</span><br><span class="line">zrf@debian:/etc/netns/sun/swanctl$ sudo cp /tmp/sm2_cert/sunKey.pem private/</span><br><span class="line">zrf@debian:/etc/netns/sun/swanctl$ sudo cp /tmp/sm2_cert/caCert.pem x509ca/</span><br><span class="line"></span><br><span class="line">zrf@debian:/etc/netns/moon/swanctl$ sudo cp /tmp/sm2_cert/moonCert.pem x509/</span><br><span class="line">zrf@debian:/etc/netns/moon/swanctl$ sudo cp /tmp/sm2_cert/moonKey.pem private/</span><br><span class="line">zrf@debian:/etc/netns/moon/swanctl$ sudo cp /tmp/sm2_cert/caCert.pem x509ca/</span><br></pre></td></tr></table></figure>

<h3 id="3-2-sun站点配置"><a href="#3-2-sun站点配置" class="headerlink" title="3.2 sun站点配置"></a>3.2 sun站点配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:~$ cat /etc/netns/sun/swanctl/conf.d/swanctl.conf </span><br><span class="line">connections &#123;</span><br><span class="line"></span><br><span class="line">   h2h &#123;</span><br><span class="line">      local_addrs  = 10.1.0.1</span><br><span class="line">      remote_addrs = 10.1.0.2</span><br><span class="line"></span><br><span class="line">      local &#123;</span><br><span class="line">        auth = pubkey</span><br><span class="line">        certs = sunCert.pem</span><br><span class="line">        id = &quot;C=CN, O=zrf, CN=zrf sun&quot;</span><br><span class="line">      &#125;</span><br><span class="line">      remote &#123;</span><br><span class="line">        auth = pubkey</span><br><span class="line">        id = &quot;C=CN, O=zrf, CN=zrf moon&quot;</span><br><span class="line">      &#125;</span><br><span class="line">      children &#123;</span><br><span class="line">         h2h &#123;</span><br><span class="line">            start_action = trap</span><br><span class="line">            esp_proposals = aes128-sha1</span><br><span class="line">            remote_ts = 10.1.0.2/32</span><br><span class="line">            local_ts = 10.1.0.1/32</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      version = 1</span><br><span class="line">      proposals = sm2-sm3-sm4</span><br><span class="line">      mobike = no</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-moon站点配置"><a href="#3-3-moon站点配置" class="headerlink" title="3.3 moon站点配置"></a>3.3 moon站点配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">connections &#123;</span><br><span class="line"></span><br><span class="line">   h2h &#123;</span><br><span class="line">      local_addrs  = 10.1.0.2</span><br><span class="line">      remote_addrs = 10.1.0.1</span><br><span class="line"></span><br><span class="line">      local &#123;</span><br><span class="line">        auth = pubkey</span><br><span class="line">        certs = moonCert.pem</span><br><span class="line">        id = &quot;C=CN, O=zrf, CN=zrf moon&quot;</span><br><span class="line">      &#125;</span><br><span class="line">      remote &#123;</span><br><span class="line">        auth = pubkey</span><br><span class="line">        id = &quot;C=CN, O=zrf, CN=zrf sun&quot;</span><br><span class="line">      &#125;</span><br><span class="line">      children &#123;</span><br><span class="line">         h2h &#123;</span><br><span class="line">            start_action = trap</span><br><span class="line">            esp_proposals = aes128-sha1</span><br><span class="line">            remote_ts = 10.1.0.1/32</span><br><span class="line">            local_ts = 10.1.0.2/32</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      version = 1</span><br><span class="line">      proposals = sm2-sm3-sm4</span><br><span class="line">      mobike = no</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-两个站点加载配置并读取证书"><a href="#3-3-两个站点加载配置并读取证书" class="headerlink" title="3.3 两个站点加载配置并读取证书"></a>3.3 两个站点加载配置并读取证书</h3><p>请注意，此时各自站点只有自己的证书和CA证书，并没有对端的证书，这意味着在协商IKE时会<strong>请求对端发送证书</strong>。</p>
<ul>
<li>sun</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> sun  /usr/local/sbin/swanctl -q</span><br><span class="line">loaded certificate from <span class="string">&#x27;/etc/swanctl/x509/sunCert.pem&#x27;</span></span><br><span class="line">loaded certificate from <span class="string">&#x27;/etc/swanctl/x509ca/caCert.pem&#x27;</span></span><br><span class="line">loaded SM2 key from <span class="string">&#x27;/etc/swanctl/private/sunKey.pem&#x27;</span></span><br><span class="line">no authorities found, 0 unloaded</span><br><span class="line">no pools found, 0 unloaded</span><br><span class="line">loaded connection <span class="string">&#x27;h2h&#x27;</span></span><br><span class="line">successfully loaded 1 connections, 0 unloaded</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">zrf@debian:~$ <span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> sun  /usr/local/sbin/swanctl -x</span><br><span class="line"></span><br><span class="line">List of X.509 End Entity Certificates</span><br><span class="line"></span><br><span class="line">  subject:  <span class="string">&quot;C=CN, O=zrf, CN=zrf sun&quot;</span></span><br><span class="line">  issuer:   <span class="string">&quot;C=CN, O=zrf, CN=zrf CA&quot;</span></span><br><span class="line">  validity:  not before Mar 30 16:13:17 2024, ok</span><br><span class="line">             not after  Mar 30 16:13:17 2029, ok (expires <span class="keyword">in</span> 1825 days)</span><br><span class="line">  serial:    01</span><br><span class="line">  altNames:  10.1.0.1</span><br><span class="line">  flags:     </span><br><span class="line">  authkeyId: 8a:12:af:31:8e:83:b5:4b:2c:bb:b1:5d:de:<span class="built_in">fc</span>:4f:3b:63:a8:2a:f9</span><br><span class="line">  subjkeyId: 8c:8d:09:68:79:d1:71:d2:6f:78:fd:62:98:1b:7f:9b:92:<span class="built_in">dd</span>:c7:9d</span><br><span class="line">  pubkey:    SM2 256 bits, has private key</span><br><span class="line">  keyid:     67:ad:37:f5:6a:58:8c:ae:11:d9:ef:21:56:0b:5d:7f:0d:7f:8f:9a</span><br><span class="line">  subjkey:   8c:8d:09:68:79:d1:71:d2:6f:78:fd:62:98:1b:7f:9b:92:<span class="built_in">dd</span>:c7:9d</span><br><span class="line"></span><br><span class="line">List of X.509 CA Certificates</span><br><span class="line"></span><br><span class="line">  subject:  <span class="string">&quot;C=CN, O=zrf, CN=zrf CA&quot;</span></span><br><span class="line">  issuer:   <span class="string">&quot;C=CN, O=zrf, CN=zrf CA&quot;</span></span><br><span class="line">  validity:  not before Mar 30 16:01:08 2024, ok</span><br><span class="line">             not after  Mar 30 16:01:08 2034, ok (expires <span class="keyword">in</span> 3651 days)</span><br><span class="line">  serial:    55:43:e9:a5:8d:<span class="built_in">dd</span>:c9:c7</span><br><span class="line">  flags:     CA CRLSign self-signed </span><br><span class="line">  subjkeyId: 8a:12:af:31:8e:83:b5:4b:2c:bb:b1:5d:de:<span class="built_in">fc</span>:4f:3b:63:a8:2a:f9</span><br><span class="line">  pubkey:    SM2 256 bits</span><br><span class="line">  keyid:     e8:56:19:cf:d3:ec:b7:1e:2e:<span class="built_in">fc</span>:78:d5:e7:ef:22:8a:<span class="built_in">dd</span>:f1:53:3b</span><br><span class="line">  subjkey:   8a:12:af:31:8e:83:b5:4b:2c:bb:b1:5d:de:<span class="built_in">fc</span>:4f:3b:63:a8:2a:f9</span><br><span class="line">zrf@debian:~$ </span><br></pre></td></tr></table></figure>

<ul>
<li>moon</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:~$ <span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> moon /usr/local/sbin/swanctl -q</span><br><span class="line">loaded certificate from <span class="string">&#x27;/etc/swanctl/x509/moonCert.pem&#x27;</span></span><br><span class="line">loaded certificate from <span class="string">&#x27;/etc/swanctl/x509ca/caCert.pem&#x27;</span></span><br><span class="line">loaded SM2 key from <span class="string">&#x27;/etc/swanctl/private/moonKey.pem&#x27;</span></span><br><span class="line">no authorities found, 0 unloaded</span><br><span class="line">no pools found, 0 unloaded</span><br><span class="line">loaded connection <span class="string">&#x27;h2h&#x27;</span></span><br><span class="line">successfully loaded 1 connections, 0 unloaded</span><br><span class="line">zrf@debian:~$ </span><br><span class="line">zrf@debian:~$ </span><br><span class="line">zrf@debian:~$ </span><br><span class="line">zrf@debian:~$ <span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> moon /usr/local/sbin/swanctl -x</span><br><span class="line"></span><br><span class="line">List of X.509 End Entity Certificates</span><br><span class="line"></span><br><span class="line">  subject:  <span class="string">&quot;C=CN, O=zrf, CN=zrf moon&quot;</span></span><br><span class="line">  issuer:   <span class="string">&quot;C=CN, O=zrf, CN=zrf CA&quot;</span></span><br><span class="line">  validity:  not before Mar 30 16:19:06 2024, ok</span><br><span class="line">             not after  Mar 30 16:19:06 2029, ok (expires <span class="keyword">in</span> 1825 days)</span><br><span class="line">  serial:    02</span><br><span class="line">  altNames:  10.1.0.2</span><br><span class="line">  flags:     </span><br><span class="line">  authkeyId: 8a:12:af:31:8e:83:b5:4b:2c:bb:b1:5d:de:<span class="built_in">fc</span>:4f:3b:63:a8:2a:f9</span><br><span class="line">  subjkeyId: c2:21:56:d6:6f:19:e0:75:4f:95:7e:1a:0f:2a:d2:66:29:2a:5a:cc</span><br><span class="line">  pubkey:    SM2 256 bits, has private key</span><br><span class="line">  keyid:     d7:b6:<span class="built_in">df</span>:86:cf:<span class="built_in">dd</span>:42:c5:1f:7b:64:c9:2e:a0:29:bb:f5:56:aa:aa</span><br><span class="line">  subjkey:   c2:21:56:d6:6f:19:e0:75:4f:95:7e:1a:0f:2a:d2:66:29:2a:5a:cc</span><br><span class="line"></span><br><span class="line">List of X.509 CA Certificates</span><br><span class="line"></span><br><span class="line">  subject:  <span class="string">&quot;C=CN, O=zrf, CN=zrf CA&quot;</span></span><br><span class="line">  issuer:   <span class="string">&quot;C=CN, O=zrf, CN=zrf CA&quot;</span></span><br><span class="line">  validity:  not before Mar 30 16:01:08 2024, ok</span><br><span class="line">             not after  Mar 30 16:01:08 2034, ok (expires <span class="keyword">in</span> 3651 days)</span><br><span class="line">  serial:    55:43:e9:a5:8d:<span class="built_in">dd</span>:c9:c7</span><br><span class="line">  flags:     CA CRLSign self-signed </span><br><span class="line">  subjkeyId: 8a:12:af:31:8e:83:b5:4b:2c:bb:b1:5d:de:<span class="built_in">fc</span>:4f:3b:63:a8:2a:f9</span><br><span class="line">  pubkey:    SM2 256 bits</span><br><span class="line">  keyid:     e8:56:19:cf:d3:ec:b7:1e:2e:<span class="built_in">fc</span>:78:d5:e7:ef:22:8a:<span class="built_in">dd</span>:f1:53:3b</span><br><span class="line">  subjkey:   8a:12:af:31:8e:83:b5:4b:2c:bb:b1:5d:de:<span class="built_in">fc</span>:4f:3b:63:a8:2a:f9</span><br></pre></td></tr></table></figure>

<h3 id="3-4-协商IKE-SA"><a href="#3-4-协商IKE-SA" class="headerlink" title="3.4 协商IKE SA"></a>3.4 协商IKE SA</h3><p>moon站点发起协商：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:~$ <span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> moon /usr/local/sbin/swanctl -i -i h2h</span><br><span class="line">[IKE] initiating Main Mode IKE_SA h2h[3] to 10.1.0.1</span><br><span class="line">[ENC] generating ID_PROT request 0 [ SA V V V V V ]</span><br><span class="line">[NET] sending packet: from 10.1.0.2[500] to 10.1.0.1[500] (176 bytes)</span><br><span class="line">[NET] received packet: from 10.1.0.1[500] to 10.1.0.2[500] (156 bytes)</span><br><span class="line">[ENC] parsed ID_PROT response 0 [ SA V V V V ]</span><br><span class="line">[IKE] received XAuth vendor ID</span><br><span class="line">[IKE] received DPD vendor ID</span><br><span class="line">[IKE] received FRAGMENTATION vendor ID</span><br><span class="line">[IKE] received NAT-T (RFC 3947) vendor ID</span><br><span class="line">[CFG] selected proposal: IKE:SM4_CBC/HMAC_SM3/PRF_HMAC_SM3/CURVE_SM2</span><br><span class="line">[ENC] generating ID_PROT request 0 [ KE No NAT-D NAT-D ]</span><br><span class="line">[NET] sending packet: from 10.1.0.2[500] to 10.1.0.1[500] (204 bytes)</span><br><span class="line">[NET] received packet: from 10.1.0.1[500] to 10.1.0.2[500] (255 bytes)</span><br><span class="line">[ENC] parsed ID_PROT response 0 [ KE No CERTREQ NAT-D NAT-D ]</span><br><span class="line">[IKE] received cert request <span class="keyword">for</span> <span class="string">&#x27;C=CN, O=zrf, CN=zrf CA&#x27;</span></span><br><span class="line">[IKE] sending cert request <span class="keyword">for</span> <span class="string">&quot;C=CN, O=zrf, CN=zrf CA&quot;</span></span><br><span class="line">[IKE] authentication of <span class="string">&#x27;C=CN, O=zrf, CN=zrf moon&#x27;</span> (myself) successful</span><br><span class="line">[IKE] sending end entity cert <span class="string">&quot;C=CN, O=zrf, CN=zrf moon&quot;</span></span><br><span class="line">[ENC] generating ID_PROT request 0 [ ID CERT SIG CERTREQ N(INITIAL_CONTACT) ]</span><br><span class="line">[NET] sending packet: from 10.1.0.2[500] to 10.1.0.1[500] (620 bytes)</span><br><span class="line">[NET] received packet: from 10.1.0.1[500] to 10.1.0.2[500] (540 bytes)</span><br><span class="line">[ENC] parsed ID_PROT response 0 [ ID CERT SIG ]</span><br><span class="line">[IKE] received end entity cert <span class="string">&quot;C=CN, O=zrf, CN=zrf sun&quot;</span></span><br><span class="line">[CFG]   using certificate <span class="string">&quot;C=CN, O=zrf, CN=zrf sun&quot;</span></span><br><span class="line">[CFG]   using trusted ca certificate <span class="string">&quot;C=CN, O=zrf, CN=zrf CA&quot;</span></span><br><span class="line">[CFG]   reached self-signed root ca with a path length of 0</span><br><span class="line">[CFG] checking certificate status of <span class="string">&quot;C=CN, O=zrf, CN=zrf sun&quot;</span></span><br><span class="line">[CFG] certificate status is not available</span><br><span class="line">[IKE] authentication of <span class="string">&#x27;C=CN, O=zrf, CN=zrf sun&#x27;</span> with SM2_WITH_SM2 successful</span><br><span class="line">[IKE] IKE_SA h2h[3] established between 10.1.0.2[C=CN, O=zrf, CN=zrf moon]...10.1.0.1[C=CN, O=zrf, CN=zrf sun]</span><br><span class="line">[IKE] scheduling rekeying <span class="keyword">in</span> 14089s</span><br><span class="line">[IKE] maximum IKE_SA lifetime 15529s</span><br><span class="line">initiate completed successfully</span><br></pre></td></tr></table></figure>

<p>查看<code>IKE SA</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:~$ <span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> moon /usr/local/sbin/swanctl -l</span><br><span class="line">h2h: <span class="comment">#3, ESTABLISHED, IKEv1, 68d381f382237777_i* ea6feabcf2a1a98f_r</span></span><br><span class="line">  <span class="built_in">local</span>  <span class="string">&#x27;C=CN, O=zrf, CN=zrf moon&#x27;</span> @ 10.1.0.2[500]</span><br><span class="line">  remote <span class="string">&#x27;C=CN, O=zrf, CN=zrf sun&#x27;</span> @ 10.1.0.1[500]</span><br><span class="line">  SM4_CBC/HMAC_SM3/PRF_HMAC_SM3/CURVE_SM2</span><br><span class="line">  established 25s ago, rekeying <span class="keyword">in</span> 14064s</span><br></pre></td></tr></table></figure>

<h3 id="3-5-总结"><a href="#3-5-总结" class="headerlink" title="3.5 总结"></a>3.5 总结</h3><p>我们使用<code>SM4_CBC/HMAC_SM3/PF_HMAC_SM3/CURVE_SM2</code>安全提案在<code>sun站点</code>和<code>moon站点</code>之间成功建立的<code>IKE SA</code>。</p>
<h2 id="四-报文分析"><a href="#四-报文分析" class="headerlink" title="四. 报文分析"></a>四. 报文分析</h2><p>本节观察此次协商过程的报文信息。</p>
<p><img src="/blog_image/IKEv1_pubkey_auth/image1.png" alt="ISAKMP Main Mode 三次交换"></p>
<h3 id="4-1-创建安全提案"><a href="#4-1-创建安全提案" class="headerlink" title="4.1 创建安全提案"></a>4.1 创建安全提案</h3><p>通过第一次交换(一次请求加一次响应称为一次交换)，双方决定使用<code>SM4_CBC/HMAC_SM3/PF_HMAC_SM3/CURVE_SM2</code>作为安全提案。</p>
<p>可见加密算法为SM4-CBC，摘要算法为SM3, DH算法为2049(我将SM2的DH算法定义为了2049)，签名算法为12（我将SM2-with-SM3定义为了12）</p>
<p><img src="/blog_image/IKEv1_pubkey_auth/image2.png" alt="Transform"></p>
<h3 id="4-2-交换DH公钥"><a href="#4-2-交换DH公钥" class="headerlink" title="4.2 交换DH公钥"></a>4.2 交换DH公钥</h3><p>本节将首先展示DH算法是如何不在网络间传输共享密钥的前提下，双方通过交换可公开的DH公钥，各自计算出共享密钥g_xy的。</p>
<p>其次分析strongswan的代码，研究一下如何通过共享密钥衍生出一系列密钥。</p>
<h4 id="1-DH算法"><a href="#1-DH算法" class="headerlink" title="1. DH算法"></a>1. DH算法</h4><p>strongswan对DH算法抽象出了三个最常用的方法。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implementation of a key exchange algorithms (e.g. Diffie-Hellman).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key_exchange_t</span> &#123;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Returns the shared secret of this key exchange method.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @param secret shared secret (allocated)</span></span><br><span class="line"><span class="comment">  * @return   TRUE if shared secret computed successfully</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="type">bool</span> (*get_shared_secret)(<span class="type">key_exchange_t</span> *this, <span class="type">chunk_t</span> *secret)</span><br><span class="line">  __attribute__((warn_unused_result));</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Sets the public key from the peer.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @note This operation should be relatively quick. Costly public key</span></span><br><span class="line"><span class="comment">  * validation operations or key derivation should be implemented in</span></span><br><span class="line"><span class="comment">  * get_shared_secret().</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @param value  public key of peer</span></span><br><span class="line"><span class="comment">  * @return   TRUE if other public key verified and set</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="type">bool</span> (*set_public_key)(<span class="type">key_exchange_t</span> *this, <span class="type">chunk_t</span> value)</span><br><span class="line">  __attribute__((warn_unused_result));</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Gets the own public key to transmit.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @param value  public key (allocated)</span></span><br><span class="line"><span class="comment">  * @return   TRUE if public key retrieved</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="type">bool</span> (*get_public_key)(<span class="type">key_exchange_t</span> *this, <span class="type">chunk_t</span> *value)</span><br><span class="line">  __attribute__((warn_unused_result));</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在生成DH算法实例时会创建出<strong>一对密钥——公钥和私钥</strong>。<br>我们举一个例子，A和B之间想协商出一个共享密钥，他们需要这样做：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">            A                       B</span><br><span class="line">            |                       |</span><br><span class="line">            |                       v</span><br><span class="line">            v               创建DH实例DH_B(pub_b, pri_b)</span><br><span class="line">            |                       |   </span><br><span class="line">    创建DH实例DH_A(pub_a, pri_a)     |       </span><br><span class="line">            |                       |</span><br><span class="line">            v                       |</span><br><span class="line">            |------发送pub_a------&gt; |</span><br><span class="line">            |                       |</span><br><span class="line">            |&lt;------发送pub_b-------|</span><br><span class="line">            |                       |</span><br><span class="line">psk1 =  sm2_dh(DH_A, pub_b)         |</span><br><span class="line">            |                       |</span><br><span class="line">            |            psk2 =  sm2_dh(DH_B, pub_a)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>pks1和psk2就是他们生成的共享密钥，psk1和psk2应该相等。</p>
<p>就像下面这段测试程序一样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;library.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;crypto/key_exchange.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;utils/chunk.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">library_t</span> *lib = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> library_init(<span class="literal">NULL</span>, <span class="string">&quot;sm2 dh test&quot;</span>);</span><br><span class="line"> lib-&gt;plugins-&gt;load(lib-&gt;plugins, <span class="string">&quot;gmssl&quot;</span>);</span><br><span class="line"></span><br><span class="line"> <span class="type">key_exchange_t</span> *DH_A;                                      <span class="type">key_exchange_t</span> *DH_B;</span><br><span class="line"> <span class="type">chunk_t</span> pub_a, psk1;                                       <span class="type">chunk_t</span> pub_b, psk2; </span><br><span class="line"> pub_a = psk1 = chunk_empty;                                pub_b = psk2 = chunk_empty;</span><br><span class="line"></span><br><span class="line"> DH_A = lib-&gt;crypto-&gt;create_ke(lib-&gt;crypto, CURVE_SM2);     DH_B = lib-&gt;crypto-&gt;create_ke(lib-&gt;crypto, CURVE_SM2);</span><br><span class="line"></span><br><span class="line"> assert(DH_A-&gt;get_public_key(DH_A, &amp;pub_a) == TRUE);        assert(DH_B-&gt;get_public_key(DH_B, &amp;pub_b) == TRUE);</span><br><span class="line"></span><br><span class="line"> assert(DH_A-&gt;set_public_key(DH_A, pub_b) == TRUE);         assert(DH_B-&gt;set_public_key(DH_B, pub_a) == TRUE);</span><br><span class="line"></span><br><span class="line"> assert(DH_A-&gt;get_shared_secret(DH_A, &amp;psk1) == TRUE);      assert(DH_B-&gt;get_shared_secret(DH_A, &amp;psk2) == TRUE);</span><br><span class="line"></span><br><span class="line"> assert(chunk_equals(psk1, psk2) == TRUE);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-KEY-EXCHANGE-PAYLOAD"><a href="#2-KEY-EXCHANGE-PAYLOAD" class="headerlink" title="2. KEY EXCHANGE PAYLOAD"></a>2. KEY EXCHANGE PAYLOAD</h4><p>我们观察第二组交换：</p>
<p><img src="/blog_image/IKEv1_pubkey_auth/image3.png" alt="KEY EXCHANGE PAYLOAD"></p>
<p>KEY EXCHANGE的有效载荷其实就是各自DH实例的公钥，需要发送给对端。</p>
<p>不难想象，对端将此KE作为对端DH实例的公钥，就可以得到共享密钥了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 发送方将KE实例的公钥拷贝到KE载荷中 */</span></span><br><span class="line"><span class="type">ke_payload_t</span> *<span class="title function_">ke_payload_create_from_key_exchange</span><span class="params">(<span class="type">payload_type_t</span> type,</span></span><br><span class="line"><span class="params">              <span class="type">key_exchange_t</span> *ke)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">private_ke_payload_t</span> *this;</span><br><span class="line"> <span class="type">chunk_t</span> value;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/* 获取了KE实例的公钥 */</span></span><br><span class="line"> <span class="keyword">if</span> (!ke-&gt;get_public_key(ke, &amp;value))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> this = (<span class="type">private_ke_payload_t</span>*)ke_payload_create(type);</span><br><span class="line"> <span class="comment">/* 并把公钥存放在KE的载荷中 */</span></span><br><span class="line"> this-&gt;key_exchange_data = value;</span><br><span class="line"> this-&gt;ke_method = ke-&gt;get_method(ke);</span><br><span class="line"> this-&gt;payload_length += this-&gt;key_exchange_data.len;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> &amp;this-&gt;public;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 接收方收到KE后将dh_value设置为public key */</span></span><br><span class="line">METHOD(<span class="type">phase1_t</span>, get_nonce_ke, <span class="type">bool</span>,</span><br><span class="line"> <span class="type">private_phase1_t</span> *this, <span class="type">message_t</span> *message)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">ke_payload_t</span> *ke_payload;</span><br><span class="line"></span><br><span class="line"> ke_payload = (<span class="type">ke_payload_t</span>*)message-&gt;get_payload(message, PLV1_KEY_EXCHANGE);</span><br><span class="line"> this-&gt;dh_value = chunk_clone(ke_payload-&gt;get_key_exchange_data(ke_payload));</span><br><span class="line"> <span class="keyword">if</span> (!this-&gt;dh-&gt;set_public_key(this-&gt;dh, this-&gt;dh_value))</span><br><span class="line"> &#123;</span><br><span class="line">  DBG1(DBG_IKE, <span class="string">&quot;unable to apply received KE value&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> FALSE;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">METHOD(<span class="type">keymat_v1_t</span>, derive_ike_keys, <span class="type">bool</span>,</span><br><span class="line"> <span class="type">private_keymat_v1_t</span> *this, <span class="type">proposal_t</span> *proposal, <span class="type">key_exchange_t</span> *dh,</span><br><span class="line"> <span class="type">chunk_t</span> dh_other, <span class="type">chunk_t</span> nonce_i, <span class="type">chunk_t</span> nonce_r, <span class="type">ike_sa_id_t</span> *id,</span><br><span class="line"> <span class="type">auth_method_t</span> auth, <span class="type">shared_key_t</span> *shared_key)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">chunk_t</span> g_xy, g_xi, g_xr, dh_me, spi_i, spi_r, nonces, data, skeyid_e;</span><br><span class="line"> <span class="type">chunk_t</span> skeyid, ka;</span><br><span class="line"> <span class="type">uint16_t</span> alg;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 使用get_shared_secret方法，得到了共享密钥g_xy */</span></span><br><span class="line"> <span class="keyword">if</span> (!dh-&gt;get_shared_secret(dh, &amp;g_xy))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">return</span> FALSE;</span><br><span class="line"> &#125;</span><br><span class="line"> DBG4(DBG_IKE, <span class="string">&quot;shared Diffie Hellman secret %B&quot;</span>, &amp;g_xy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h4><p>至此，我们已经通过DH算法令双方都获取到了共享密钥(g_xy)。但是这个共享密钥并不会直接作为加&#x2F;解密的密钥。<br>下一节将分析用来保护IKE_AUTH阶段的密钥是如何产生的。</p>
<h2 id="五-保护IKE-AUTH的密钥是如何产生的"><a href="#五-保护IKE-AUTH的密钥是如何产生的" class="headerlink" title="五. 保护IKE_AUTH的密钥是如何产生的"></a>五. 保护IKE_AUTH的密钥是如何产生的</h2><p>本节的内容就是按照IKEv1协议要求，来衍生密钥的。</p>
<h3 id="5-1-SKEYID"><a href="#5-1-SKEYID" class="headerlink" title="5.1 SKEYID"></a>5.1 SKEYID</h3><p>IKE有证书认证和预共享密钥认证，这两种认证方法产生的SKEYID是不同的：</p>
<ul>
<li><p>预共享密钥：<br>SKEYID &#x3D; prf(pre-shared-key, Ni_b | Nr_b)<br>  其中pre-shared-key为预共享密钥，Ni_b和Nr_b为双方的Nonce值(同KE一起交换)<br>  将使用<code>pre-shared-key</code>为prf算法的key，<code>Ni_b | Nr_b</code>作为prf算法的data，得到一个HASH值，就是SKEYID</p>
</li>
<li><p>证书认证：<br>SKEYID &#x3D; prf(Ni_b | Nr_b, g_xy)<br>  Ni_b和Nr_b为双方的Nonce值(同KE一起交换)，g_xy就是通过DH算法交换的共享密钥。<br>  将使用<code>Ni_b | Nr_b</code>为prf算法的key，<code>g_xy</code>作为prf算法的data，得到一个HASH值，就是SKEYID</p>
</li>
</ul>
<h3 id="5-2-SKEYID-d"><a href="#5-2-SKEYID-d" class="headerlink" title="5.2 SKEYID_d"></a>5.2 SKEYID_d</h3><p>SKEYID_d &#x3D; prf(SKEYID, g^xy | CKY-I | CKY-R | 0)<br>    CKY-I&#x2F;CKY-R就是发起者和响应者的SPI</p>
<h3 id="5-3-SKEYID-a"><a href="#5-3-SKEYID-a" class="headerlink" title="5.3 SKEYID_a"></a>5.3 SKEYID_a</h3><p>SKEYID_a &#x3D; prf(SKEYID, SKEYID_d | g^xy | CKY-I | CKY-R | 1)<br>    CKY-I&#x2F;CKY-R就是发起者和响应者的SPI</p>
<h3 id="5-4-SKEYID-e"><a href="#5-4-SKEYID-e" class="headerlink" title="5.4 SKEYID_e"></a>5.4 SKEYID_e</h3><p>SKEYID_e &#x3D; prf(SKEYID, SKEYID_a | g^xy | CKY-I | CKY-R | 2)<br>    CKY-I&#x2F;CKY-R就是发起者和响应者的SPI</p>
<h3 id="5-5-KA"><a href="#5-5-KA" class="headerlink" title="5.5 KA"></a>5.5 KA</h3><p>KA比较关键，他是由<code>SKEYID_e</code>衍生的：</p>
<p>K1 &#x3D; prf(SKEYID_e, 0)<br>K2 &#x3D; prf(SKEYID_e, K1)<br>K3 &#x3D; prf(SKEYID_e, K2)<br>Ka &#x3D; K1 | K2 | K3</p>
<p>这个KA将作为最终的密钥，对IKE_AUTH进行加密。</p>
<h2 id="六-证书认证"><a href="#六-证书认证" class="headerlink" title="六. 证书认证"></a>六. 证书认证</h2><p>接下来，所有的ISAKMP的有效载荷将被<code>KA</code>加密，我们可以拿到KA和SPI对密文解密</p>
<p>ikev1_decryption_table有两个是因为网络空间的sun和moon都记录了解密信息，他们当然应当是一样的。</p>
<p>如果使用的国际的加密和摘要算法，是可以通过ikev1_decryption_table表来解密ISAKMP报文的，但是我用的是SM3&#x2F;SM4算法，wireshark无法解密，所以后文中的解密信息都是在使用sha1&#x2F;aes128算法下的信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zrf@debian:~$ <span class="built_in">cat</span> /tmp/ikev1_decryption_table </span><br><span class="line">68d381f382237777,4a843753e8fa6d3974ad2ae4e614b8a2</span><br><span class="line">68d381f382237777,4a843753e8fa6d3974ad2ae4e614b8a2</span><br></pre></td></tr></table></figure>

<h3 id="6-1-证书请求"><a href="#6-1-证书请求" class="headerlink" title="6.1 证书请求"></a>6.1 证书请求</h3><p>由于我们是证书认证，实际上在第四条报文中，会携带一个证书请求，期望对方发送被CA认可的证书：</p>
<p><img src="/blog_image/IKEv1_pubkey_auth/image4.png" alt="Cert Req"></p>
<h3 id="6-2-IKE-AUTH"><a href="#6-2-IKE-AUTH" class="headerlink" title="6.2 IKE_AUTH"></a>6.2 IKE_AUTH</h3><p>在进行IKE_AUTH时，解密后的有效载荷主要由这几部分组成：</p>
<p><img src="/blog_image/IKEv1_pubkey_auth/image5.png" alt="IKE_AUTH"></p>
<p>我们将主要查看他的<code>Payload: Identification (5)字段</code>、<code>Payload: Certificate (6)字段</code>和<code>Payload: Signature (9)字段</code></p>
<h4 id="1-Identification"><a href="#1-Identification" class="headerlink" title="1. Identification"></a>1. Identification</h4><p>本字段记录了发送端的ID信息，这个ID信息就是从moonCert.pem中获得的。</p>
<p><img src="/blog_image/IKEv1_pubkey_auth/image6.png" alt="Identification"></p>
<h4 id="2-Certificate"><a href="#2-Certificate" class="headerlink" title="2. Certificate"></a>2. Certificate</h4><p>本字段就是moonCert.pem证书，这是由于sun在第四个报文中发送了<code>证书请求</code></p>
<p><img src="/blog_image/IKEv1_pubkey_auth/image7.png" alt="Certificate"></p>
<h4 id="3-Signature"><a href="#3-Signature" class="headerlink" title="3. Signature"></a>3. Signature</h4><p>这个字段就比较关键了，关系到IKE_AUTH能否注册成功，我们将在下一节来分析签名是如何产生的、接收端将如何验签。</p>
<p><img src="/blog_image/IKEv1_pubkey_auth/image8.png" alt="Signature"></p>
<h3 id="6-3-签名与验签"><a href="#6-3-签名与验签" class="headerlink" title="6.3 签名与验签"></a>6.3 签名与验签</h3><p>本节分两部分：</p>
<ul>
<li>分析发起者如何进行签名</li>
<li>分析接受者如何验证签名</li>
</ul>
<h4 id="1-签名"><a href="#1-签名" class="headerlink" title="1. 签名"></a>1. 签名</h4><p>以下是构造签名的过程，请看注释</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">METHOD(<span class="type">authenticator_t</span>, build, <span class="type">status_t</span>,</span><br><span class="line"> <span class="type">private_pubkey_v1_authenticator_t</span> *this, <span class="type">message_t</span> *message)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">/* 获取本端的ID */</span></span><br><span class="line"> id = this-&gt;ike_sa-&gt;get_my_id(this-&gt;ike_sa);</span><br><span class="line"> <span class="comment">/* 获取本端的私钥 */</span></span><br><span class="line"> private = lib-&gt;credmgr-&gt;get_private(lib-&gt;credmgr, this-&gt;type, id, auth);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 获取本端DH实例的公钥 */</span></span><br><span class="line"> <span class="keyword">if</span> (!this-&gt;dh-&gt;get_public_key(this-&gt;dh, &amp;dh))</span><br><span class="line"> &#123;</span><br><span class="line">  private-&gt;destroy(private);</span><br><span class="line">  <span class="keyword">return</span> FAILED;</span><br><span class="line"> &#125;</span><br><span class="line"> keymat = (<span class="type">keymat_v1_t</span>*)this-&gt;ike_sa-&gt;get_keymat(this-&gt;ike_sa);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 计算这些值的摘要 */</span></span><br><span class="line"> <span class="keyword">if</span> (!keymat-&gt;get_hash(keymat, this-&gt;initiator, dh, this-&gt;dh_value,</span><br><span class="line">     this-&gt;ike_sa-&gt;get_id(this-&gt;ike_sa), this-&gt;sa_payload,</span><br><span class="line">     this-&gt;id_payload, &amp;hash, &amp;scheme))</span><br><span class="line"> &#123;</span><br><span class="line">  private-&gt;destroy(private);</span><br><span class="line">  <span class="built_in">free</span>(dh.ptr);</span><br><span class="line">  <span class="keyword">return</span> FAILED;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">free</span>(dh.ptr);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 对摘要进行私钥签名 */</span></span><br><span class="line"> <span class="keyword">if</span> (private-&gt;sign(private, scheme, <span class="literal">NULL</span>, hash, &amp;sig))</span><br><span class="line"> &#123;</span><br><span class="line">  sig_payload = hash_payload_create(PLV1_SIGNATURE);</span><br><span class="line">  sig_payload-&gt;set_hash(sig_payload, sig);</span><br><span class="line">  <span class="built_in">free</span>(sig.ptr);</span><br><span class="line">  message-&gt;add_payload(message, &amp;sig_payload-&gt;payload_interface);</span><br><span class="line">  status = SUCCESS;</span><br><span class="line">  DBG1(DBG_IKE, <span class="string">&quot;authentication of &#x27;%Y&#x27; (myself) successful&quot;</span>, id);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-验签"><a href="#2-验签" class="headerlink" title="2. 验签"></a>2. 验签</h4><p>验证签名的过程，请看注释</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">METHOD(<span class="type">authenticator_t</span>, process, <span class="type">status_t</span>,</span><br><span class="line"> <span class="type">private_pubkey_v1_authenticator_t</span> *this, <span class="type">message_t</span> *message)</span><br><span class="line">&#123;</span><br><span class="line"> sig_payload = (<span class="type">hash_payload_t</span>*)message-&gt;get_payload(message, PLV1_SIGNATURE);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 获取到对端ID */</span></span><br><span class="line"> id = this-&gt;ike_sa-&gt;get_other_id(this-&gt;ike_sa);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 获取本端DH实例的公钥 */</span></span><br><span class="line"> <span class="keyword">if</span> (!this-&gt;dh-&gt;get_public_key(this-&gt;dh, &amp;dh))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">return</span> FAILED;</span><br><span class="line"> &#125;</span><br><span class="line"> keymat = (<span class="type">keymat_v1_t</span>*)this-&gt;ike_sa-&gt;get_keymat(this-&gt;ike_sa);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 计算这些值的摘要 */</span></span><br><span class="line"> <span class="keyword">if</span> (!keymat-&gt;get_hash(keymat, !this-&gt;initiator, this-&gt;dh_value, dh,</span><br><span class="line">     this-&gt;ike_sa-&gt;get_id(this-&gt;ike_sa), this-&gt;sa_payload,</span><br><span class="line">     this-&gt;id_payload, &amp;hash, &amp;scheme))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="built_in">free</span>(dh.ptr);</span><br><span class="line">  <span class="keyword">return</span> FAILED;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">free</span>(dh.ptr);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 获取到签名的载荷 */</span></span><br><span class="line"> sig = sig_payload-&gt;get_hash(sig_payload);</span><br><span class="line"> auth = this-&gt;ike_sa-&gt;get_auth_cfg(this-&gt;ike_sa, FALSE);</span><br><span class="line"> enumerator = lib-&gt;credmgr-&gt;create_public_enumerator(lib-&gt;credmgr, this-&gt;type,</span><br><span class="line">              id, auth, TRUE);</span><br><span class="line"> <span class="keyword">while</span> (enumerator-&gt;enumerate(enumerator, &amp;public, &amp;current_auth))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="comment">/* 使用信任的公钥进行验签 */</span></span><br><span class="line">  <span class="keyword">if</span> (public-&gt;verify(public, scheme, <span class="literal">NULL</span>, hash, sig) &amp;&amp;</span><br><span class="line">   is_compliant_cert(current_auth))</span><br><span class="line">  &#123;</span><br><span class="line">   DBG1(DBG_IKE, <span class="string">&quot;authentication of &#x27;%Y&#x27; with %N successful&quot;</span>,</span><br><span class="line">     id, signature_scheme_names, scheme);</span><br><span class="line">   status = SUCCESS;</span><br><span class="line">   auth-&gt;merge(auth, current_auth, FALSE);</span><br><span class="line">   auth-&gt;add(auth, AUTH_RULE_AUTH_CLASS, AUTH_CLASS_PUBKEY);</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-如何获得对端的公钥"><a href="#6-4-如何获得对端的公钥" class="headerlink" title="6.4 如何获得对端的公钥"></a>6.4 如何获得对端的公钥</h3><p>在验证签名的时候我们可以发现，将使用对端的公钥进行验签，这个公钥就是通过<code>证书请求</code>获得的。</p>
<p>但是并不是随便的证书都可行，他需要被CA来验证。</p>
<p>我们可以看以下log:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">12[CFG1] &lt;h2h|3&gt;   using certificate &quot;C=CN, O=zrf, CN=zrf moon&quot;</span><br><span class="line">12[CFG2] &lt;h2h|3&gt;   certificate &quot;C=CN, O=zrf, CN=zrf moon&quot; key: 256 bit SM2</span><br><span class="line">12[CFG1] &lt;h2h|3&gt;   using trusted ca certificate &quot;C=CN, O=zrf, CN=zrf CA&quot;</span><br><span class="line">12[CFG2] &lt;h2h|3&gt;   certificate &quot;C=CN, O=zrf, CN=zrf CA&quot; key: 256 bit SM2</span><br><span class="line">12[CFG1] &lt;h2h|3&gt;   reached self-signed root ca with a path length of 0</span><br><span class="line">12[CFG1] &lt;h2h|3&gt; checking certificate status of &quot;C=CN, O=zrf, CN=zrf moon&quot;</span><br><span class="line">12[CFG2] &lt;h2h|3&gt; ocsp check skipped, no ocsp found</span><br><span class="line">12[CFG1] &lt;h2h|3&gt; certificate status is not available</span><br><span class="line">12[IKE1] &lt;h2h|3&gt; authentication of &#x27;C=CN, O=zrf, CN=zrf moon&#x27; with SM2_WITH_SM2 successful</span><br></pre></td></tr></table></figure>

<p>只有被CA信任的证书才会作为验签公钥的候选。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zzzzrf.github.io">zrf</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zzzzrf.github.io/2024/03/30/IKEv1_pubkey_auth/">https://zzzzrf.github.io/2024/03/30/IKEv1_pubkey_auth/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zzzzrf.github.io" target="_blank">zrf's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/strongswan/">strongswan</a><a class="post-meta__tags" href="/tags/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/">非对称加密算法</a><a class="post-meta__tags" href="/tags/CA%E6%9C%BA%E6%9E%84%E4%B8%8E%E8%AF%81%E4%B9%A6/">CA机构与证书</a><a class="post-meta__tags" href="/tags/%E5%9B%BD%E5%AF%86%E7%AE%97%E6%B3%95/">国密算法</a><a class="post-meta__tags" href="/tags/%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81/">证书认证</a></div><div class="post-share"><div class="social-share" data-image="/blog_image/20231203-01/cover.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>感谢支持</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat_pay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat_pay.jpg"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/03/10/netlink_dump/" title="应当如何解析多部分Netlink消息？"><img class="cover" src="/blog_image/netlink/netlink.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">应当如何解析多部分Netlink消息？</div></div><div class="info-2"><div class="info-item-1">用户态进程偶尔会向内核请求某个对象的列表，此时，用户态进程应当如何正确地接收来自内核的多部分消息(NLM_F_MULTI)呢？</div></div></div></a><a class="pagination-related" href="/2024/05/26/trace_esp/" title="Trace ESP Packet"><img class="cover" src="/blog_image/XFRM-state/ipsec.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Trace ESP Packet</div></div><div class="info-2"><div class="info-item-1">分析一个ESP Packet在协议栈的input方向和output方向是如何处理的,仅仅涉及重要的函数名,用以显示调用关系与注册时机,不会陷入到具体的实现细节之中。</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2023/12/03/20231203-01/" title="非对称加密算法与CA机构"><img class="cover" src="/blog_image/20231203-01/cover.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-03</div><div class="info-item-2">非对称加密算法与CA机构</div></div><div class="info-2"><div class="info-item-1">分析非对称加密算法保护数据的场景,找出两个安全隐患,继而引出数字签名和CA机构,最后将演示如何创建CA，如何使用CA为最终实体颁发证书</div></div></div></a><a class="pagination-related" href="/2023/12/11/XFRM-state/" title="XFRM state"><img class="cover" src="/blog_image/XFRM-state/ipsec.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-11</div><div class="info-item-2">XFRM state</div></div><div class="info-2"><div class="info-item-1">介绍XFRM状态数据库，探讨站点到站点案例中ICMP报文的封装和加密过程</div></div></div></a><a class="pagination-related" href="/2024/05/26/trace_esp/" title="Trace ESP Packet"><img class="cover" src="/blog_image/XFRM-state/ipsec.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-26</div><div class="info-item-2">Trace ESP Packet</div></div><div class="info-2"><div class="info-item-1">分析一个ESP Packet在协议栈的input方向和output方向是如何处理的,仅仅涉及重要的函数名,用以显示调用关系与注册时机,不会陷入到具体的实现细节之中。</div></div></div></a><a class="pagination-related" href="/2024/01/19/vici/" title="Versatile IKE Control Interface"><img class="cover" src="/blog_image/XFRM-state/ipsec.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-19</div><div class="info-item-2">Versatile IKE Control Interface</div></div><div class="info-2"><div class="info-item-1">介绍多功能IKE控制接口协议，探讨在libzebra框架下集成DAVICI的方案</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">zrf</div><div class="author-info-description">求知若渴，虚心若愚</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zzzzrf"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/zzzzrf" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:853241825@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">蹒跚学步,感谢支持!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">一. 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%B8%BB%E8%A6%81%E5%86%85%E5%AE%B9"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 主要内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%85%A8%E6%96%87%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 全文结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 网络拓扑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 参考链接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6"><span class="toc-number">2.</span> <span class="toc-text">二. 创建证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%88%9B%E5%BB%BA%E8%87%AA%E7%AD%BE%E5%90%8DCA%E6%A0%B9%E8%AF%81%E4%B9%A6"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 创建自签名CA根证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E4%B8%BAsun%E7%AB%99%E7%82%B9%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 为sun站点颁发证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E4%B8%BAmoon%E7%AB%99%E7%82%B9%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 为moon站点颁发证书</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E4%BD%BF%E7%94%A8%E5%9B%BD%E5%AF%86%E7%AE%97%E6%B3%95%E5%8D%8F%E5%95%86IKE-SA"><span class="toc-number">3.</span> <span class="toc-text">三. 使用国密算法协商IKE SA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 网络拓扑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-sun%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 sun站点配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-moon%E7%AB%99%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 moon站点配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E4%B8%A4%E4%B8%AA%E7%AB%99%E7%82%B9%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E5%B9%B6%E8%AF%BB%E5%8F%96%E8%AF%81%E4%B9%A6"><span class="toc-number">3.4.</span> <span class="toc-text">3.3 两个站点加载配置并读取证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%8D%8F%E5%95%86IKE-SA"><span class="toc-number">3.5.</span> <span class="toc-text">3.4 协商IKE SA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E6%80%BB%E7%BB%93"><span class="toc-number">3.6.</span> <span class="toc-text">3.5 总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E6%8A%A5%E6%96%87%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">四. 报文分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%88%9B%E5%BB%BA%E5%AE%89%E5%85%A8%E6%8F%90%E6%A1%88"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 创建安全提案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E4%BA%A4%E6%8D%A2DH%E5%85%AC%E9%92%A5"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 交换DH公钥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-DH%E7%AE%97%E6%B3%95"><span class="toc-number">4.2.1.</span> <span class="toc-text">1. DH算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-KEY-EXCHANGE-PAYLOAD"><span class="toc-number">4.2.2.</span> <span class="toc-text">2. KEY EXCHANGE PAYLOAD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%80%BB%E7%BB%93"><span class="toc-number">4.2.3.</span> <span class="toc-text">3. 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E4%BF%9D%E6%8A%A4IKE-AUTH%E7%9A%84%E5%AF%86%E9%92%A5%E6%98%AF%E5%A6%82%E4%BD%95%E4%BA%A7%E7%94%9F%E7%9A%84"><span class="toc-number">5.</span> <span class="toc-text">五. 保护IKE_AUTH的密钥是如何产生的</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-SKEYID"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 SKEYID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-SKEYID-d"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 SKEYID_d</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-SKEYID-a"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 SKEYID_a</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-SKEYID-e"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 SKEYID_e</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-KA"><span class="toc-number">5.5.</span> <span class="toc-text">5.5 KA</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81"><span class="toc-number">6.</span> <span class="toc-text">六. 证书认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E8%AF%81%E4%B9%A6%E8%AF%B7%E6%B1%82"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 证书请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-IKE-AUTH"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 IKE_AUTH</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Identification"><span class="toc-number">6.2.1.</span> <span class="toc-text">1. Identification</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Certificate"><span class="toc-number">6.2.2.</span> <span class="toc-text">2. Certificate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Signature"><span class="toc-number">6.2.3.</span> <span class="toc-text">3. Signature</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E7%AD%BE%E5%90%8D%E4%B8%8E%E9%AA%8C%E7%AD%BE"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 签名与验签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%AD%BE%E5%90%8D"><span class="toc-number">6.3.1.</span> <span class="toc-text">1. 签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%AA%8C%E7%AD%BE"><span class="toc-number">6.3.2.</span> <span class="toc-text">2. 验签</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E5%A6%82%E4%BD%95%E8%8E%B7%E5%BE%97%E5%AF%B9%E7%AB%AF%E7%9A%84%E5%85%AC%E9%92%A5"><span class="toc-number">6.4.</span> <span class="toc-text">6.4 如何获得对端的公钥</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/02/15/20250215/" title="悉达多"><img src="/blog_image/20250215/CMCoOScDbDY0AAV3-wBgpff5.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="悉达多"/></a><div class="content"><a class="title" href="/2025/02/15/20250215/" title="悉达多">悉达多</a><time datetime="2025-02-15T11:17:26.000Z" title="发表于 2025-02-15 19:17:26">2025-02-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/06/rpi_HelloWorld/" title="裸机程序hello world"><img src="/blog_image/rpi_HelloWorld/hello_world.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="裸机程序hello world"/></a><div class="content"><a class="title" href="/2024/07/06/rpi_HelloWorld/" title="裸机程序hello world">裸机程序hello world</a><time datetime="2024-07-06T15:42:18.000Z" title="发表于 2024-07-06 23:42:18">2024-07-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/21/20240621/" title="好运设计"><img src="/blog_image/20240621/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="好运设计"/></a><div class="content"><a class="title" href="/2024/06/21/20240621/" title="好运设计">好运设计</a><time datetime="2024-06-21T15:37:14.000Z" title="发表于 2024-06-21 23:37:14">2024-06-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/16/vxlan_rfc7348/" title="VXLAN RFC7348"><img src="/blog_image/rfc7348/00.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="VXLAN RFC7348"/></a><div class="content"><a class="title" href="/2024/06/16/vxlan_rfc7348/" title="VXLAN RFC7348">VXLAN RFC7348</a><time datetime="2024-06-16T10:32:24.000Z" title="发表于 2024-06-16 18:32:24">2024-06-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/08/MakefileTutorial/" title="Makefile Tutorial"><img src="/blog_image/Makefile/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Makefile Tutorial"/></a><div class="content"><a class="title" href="/2024/06/08/MakefileTutorial/" title="Makefile Tutorial">Makefile Tutorial</a><time datetime="2024-06-08T07:19:25.000Z" title="发表于 2024-06-08 15:19:25">2024-06-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/26/trace_esp/" title="Trace ESP Packet"><img src="/blog_image/XFRM-state/ipsec.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Trace ESP Packet"/></a><div class="content"><a class="title" href="/2024/05/26/trace_esp/" title="Trace ESP Packet">Trace ESP Packet</a><time datetime="2024-05-26T14:30:13.000Z" title="发表于 2024-05-26 22:30:13">2024-05-26</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/back.jpeg);"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By zrf</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to zrf's <a href="https://zzzzrf.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = "留下你的足迹o(*￣▽￣*)ブ"

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: 'mHV5QZzhNBabMj6y5kw2SYqq-gzGzoHsz',
      appKey: '2fvaL99PG3kQNK15rc70qhMV',
      avatar: 'monsterid',
      serverURLs: 'https://mhv5qzzh.lc-cn-n1-shared.com',
      emojiMaps: "",
      visitor: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>